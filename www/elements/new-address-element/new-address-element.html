<!--
SKU details element

Example:
    <new-address-element></new-address-element>
@demo
-->

<dom-module id="new-address-element">

  <style>
    :host {
      display: block;
      box-sizing: border-box;
    }
  </style>

  <template>
    <validation-form-fields></validation-form-fields>
    <validation-phone-number phone-config="[[ phoneConfig ]]"></validation-phone-number>
    <!-- BACK BUTTON -->
    <template is="dom-if" if="[[!options.opensIndependently]]" restamp="true">
      <div class="return-trigger-container">
        <a on-tap="_goBack">[[ _translate('Back To Address Book') ]]</a>
      </div>
    </template>
    <!-- FORM -->
    <form is="iron-form" id="newAddressForm" method="GET" on-submit="_moveToSummary" novalidate>
      <template is="dom-if" if="[[options.title]]" restamp="true">
        <p class="title">[[ _translate(options.title) ]]</p>
      </template>
      <div class="input-field">
        <template is="dom-if" if="[[ isBilling ]]" restamp="true">
          <label hidden$="">[[ _translate('Cardholders Name') ]] *</label>
        </template>
        <template is="dom-if" if="[[ !isBilling ]]">
          <label>[[ _translate('Recipients Name') ]] *</label>
        </template>
        <div class="input-container with-clear">
          <input class$="validity-[[ validname ]]" type="text" is="iron-input" name="name" bind-value="{{ newAddress.name }}" data-bindvalue="newAddress.name" tabindex="1" />
          <template is="dom-if" if="[[ newAddress.name.length ]]" restamp="true">
            <a on-tap="_clearInputField" class="field-clear"><i class="wadicon-cancel"></i></a>
          </template>
          <p class="input-helper-message" hidden$="[[ validname ]]"><i class="wadicon-alert"></i>[[ _translate('Please enter your name') ]]</p>
        </div>
      </div>
      <template is="dom-if" if="[[ !isBilling ]]" restamp="true">
        <div class="input-field">
          <label>[[ _translate('Address Type') ]] *</label>
          <div class="input-container radio-options-container">
            <div class="custom-radio-container">
              <label class="custom-radio-label" for="addressTypeHome">
                <input type="radio" id="addressTypeHome" name="addressType" value="Home" on-change="_setAddressType" checked>
                <span class="label-text">[[ _translate('_addressTypeHome') ]]</span>
                <div class="check-indicator"></div>
              </label>
            </div>
            <div class="custom-radio-container">
              <label class="custom-radio-label" for="addressTypeOffice">
                <input type="radio" id="addressTypeOffice" value="Office" on-change="_setAddressType" name="addressType">
                <span class="label-text">[[ _translate('Office') ]]</span>
                <div class="check-indicator"></div>
              </label>
            </div>
            <div class="custom-radio-container">
              <label class="custom-radio-label" for="addressTypeOther">
                <input type="radio" id="addressTypeOther" value="Other" on-change="_setAddressType" name="addressType">
                <span class="label-text">[[ _translate('Other') ]]</span>
                <div class="check-indicator"></div>
             </label>
            </div>
          </div>
        </div>
      </template>
      <div class="input-field">
        <label>[[ _translate('City') ]] *</label>
        <div class="input-container">
          <input-suggest-element class$="validity-[[ validcity ]]" suggest-name="city" data-list="[[ citiesList ]]" data-selected="{{ newAddress.city }}" tabindex="2"></input-suggest-element>
          <p class="input-helper-message" hidden$="[[ validcity ]]"><i class="wadicon-alert"></i>[[ _translate('Please enter your city') ]]</p>
        </div>
      </div>
      <div class="input-field">
        <label>[[ _translate('Area') ]] *</label>
        <div class="input-container">
          <input-suggest-element class$="validity-[[ validarea ]]" custom-input="true" suggest-name="area" data-list="[[ filteredAreas ]]" data-selected="{{ newAddress.area }}" tabindex="3"></input-suggest-element>
          <p class="input-helper-message" hidden$="[[ validarea ]]"><i class="wadicon-alert"></i>[[ _translate('Please enter your area') ]]</p>
        </div>
      </div>
      <div class="input-field">
        <label><template is="dom-if" if="[[!isSA]]">[[ _translate('Address') ]] *</template> <template is="dom-if" if="[[isSA]]"><span>[[ _translate('_addressLabelHelper') ]] *</span></template></label>
        <div class="input-container with-clear">
          <input type="text" is="iron-input" class$="validity-[[ validbuilding_street_no ]]" placeholder="[[ _getCountryTranslation('_addressFieldPlaceholder', ctx.country) ]]" name="building_street_no" bind-value="{{ newAddress.building_street_no }}" data-bindvalue="newAddress.building_street_no" tabindex="4" />
          <template is="dom-if" if="[[ newAddress.building_street_no.length ]]" restamp="true">
            <a on-tap="_clearInputField" class="field-clear"><i class="wadicon-cancel"></i></a>
          </template>
          <p class="input-helper-message" hidden$="[[ validbuilding_street_no ]]"><i class="wadicon-alert"></i>[[ _translate('Please enter your address') ]]</p>
        </div>
      </div>
      <div hidden$="[[ isBilling ]]" class="input-field">
        <label>[[ _translate('NearestLandmark') ]] <span class="support">([[ _translate('optional') ]])</span></label>
        <div class="input-container">
          <textarea placeholder="[[ _getCountryTranslation('_landmarkFieldPlaceholder', ctx.country) ]]" value="{{ newAddress.landmark::input }}" tabindex="5"></textarea>
        </div>
      </div>

      <!-- PHONE NUMBER AREA -->
      <!-- COME BACK TO THIS WHEN WE'VE FIXED THE VERIFICATION ISSUE -->
      <!-- <template is="dom-if" if="[[ !isBilling ]]">
        <div class="phone-number-wrapper">
          <p hidden$="[[editPhoneNumber]]"><span>The phone number set for this address is <strong>[[newAddress.phone]]</strong></span><br /><a on-tap="_togglePhoneVerification"><i class="wadicon-chevron-right"></i>Use a different number instead</a></p>
          <p hidden$="[[!editPhoneNumber]]"><a on-tap="_togglePhoneVerification"><i class="wadicon-cancel"></i>Cancel setting new phone number</a></p>
          <phone-verification-element
            phone-config="[[ phoneConfig ]]"
            type="[[ options.type ]]"
            otp-verified="{{ phoneVerified }}"
            phone-number="{{ newAddress.phone }}"
            skip-phone-verification="{{ skipPhoneVerification }}"
            ctx="[[ ctx ]]" user="[[user]]"
            primary-phone="{{ primaryPhone }}"
            hidden$="[[!editPhoneNumber]]"
            >
          </phone-verification-element>
        </div>
      </template> -->

      <template is="dom-if" if="[[ !isBilling ]]" restamp="true">
        <template is="dom-if" if="[[ primaryPhone ]]" restamp="true">
          <div class="phone-number-wrapper">
            <phone-verification-element
              phone-config="[[ phoneConfig ]]"
              type="[[ options.type ]]"
              otp-verified="{{ phoneVerified }}"
              phone-number="{{ newAddress.phone }}"
              skip-phone-verification="{{ skipPhoneVerification }}"
              ctx="[[ ctx ]]" user="[[user]]"
              primary-phone="{{ primaryPhone }}"
              >
            </phone-verification-element>
            <div class="input-field">
              <label>[[ _translate('Alternative Phone Number') ]] <span class="support">([[ _translate('optional') ]])</span></label>
              <div class$="input-container with-clear checkout-contact-number [[ _getCountryFlag(ctx.country) ]]">
                <input type="text" is="iron-input" name="alternatePhone" bind-value="{{ alternatePhone }}" data-bindvalue="alternatePhone" prevent-invalid-input allowed-pattern="\d" type="tel" tabindex="6"/>
                <template is="dom-if" if="[[ newAddress.alternate_phone.length ]]" restamp="true">
                  <a on-tap="_clearInputField" class="field-clear"><i class="wadicon-cancel"></i></a>
                </template>
              </div>
            </div>
          </div>
        </template>
      </template>

      <p class="required-fields-message">* [[ _translate('Required fields') ]]</p>

      <template is="dom-if" if="[[ !isBilling ]]" restamp="true">
        <div class="cta-container">
          <button class="core-block-cta core-block-cta-lg cta-full-width" type="submit" disabled$="[[!canContinue]]">[[ _translate('Continue To Payment') ]]<paper-ripple></paper-ripple></button>
        </div>
      </template>

    </form>
  </template>
</dom-module>

<script>

  Polymer({
    is: 'new-address-element',

    properties: {

      /**
      * new address
      **/
      newAddress: {
        type: Object,
        value: function () {
          return {};
        },
        notify: true
      },

      /**
      * User's primary phone number
      **/
      primaryPhone: {
        type: String,
        notify: true
      },

      /**
      * List of serviceable cities
      **/
      citiesList: {
        type: Array,
        value:function() {
          return [];
        }
      },

      areasList: {
        type: Array,
        value: function () {
          return [];
        }
      },

      /**
      * can continue to payment
      **/

      canContinue: {
        type: Boolean,
        notify: true
      },

      /**
      * phone number verified
      **/

      phoneVerified: {
        type: Boolean
      },

      /**
       * Application context
       */
      ctx: {
        type: Object
      },

      options: {
        type: Object
      },

      alternatePhone: {
        type: String,
        observer: '_alternatePhoneObserver'
      }
    },

    observers: ['_addressFormValidator(phoneVerified, skipPhoneVerification, newAddress.*)'],

    // Element Lifecycle
    attached: function () {

      var _self = this;
      this.isBilling = this.options.type === 'billing' ? true : false;
      this.isMobile = window.config.device === 'mobile' ? true : false;
      this.isSA = this.ctx.country === 'sa' ? true : false;

      var addressProperties = ['name', 'city', 'area', 'building_street_no', 'phone'];

      if (this.isBilling) {
        var addressProperties = ['name', 'city', 'area', 'building_street_no'];
      }

      for (var prop = 0; prop < addressProperties.length; prop++) {
        this.set('valid' + addressProperties[prop], true);
      }
      this.phoneVerified = false;
      this.filteredAreas = [];
      this.skipPhoneVerification = false;
      this.isTypeShipping = this.options.type === 'shipping' ? true : false;
      this.validatorTextField = new Polymer.IronMeta({type: 'validator'}).byKey('validation-form-fields');
      this.validatorPhone = new Polymer.IronMeta({ type: 'validator' }).byKey('validation-phone-number');
      this.editPhoneNumber = false;

      this.set('newAddress.country', this.ctx.country);
      this.set('newAddress.isNew', true);

      newAddressForm.addEventListener('iron-form-presubmit', function (event) {
        event.preventDefault();
      });

      this.addEventListener('input-suggest-selected', function () {
        _self._inputSuggestUpdateAreas(_self);
      });

      newAddressForm.addEventListener('focusout', function (event) {
        var ele = event.target;
        if (ele && ele.getAttribute( 'name' )) {
          _self.set('valid' + ele.getAttribute('name'), _self.validatorTextField.validate(_self.get('newAddress.' + ele.getAttribute('name'))));
        }
      }, true);

      newAddressForm.addEventListener('keyup', function (event) {
        var ele = event.target;
        if ((event.which || event.keyCode) === 9) {
          var isSuggestInput = ele.className.indexOf('input-suggest-element') >= 0 || ele.tagName === 'INPUT-SUGGEST-ELEMENT';
          if (isSuggestInput) {
            ele.showControls = true;
            if (ele.querySelector('input')) {
              ele.querySelector('input').focus();
            }
          }
        }
      });

      if (this.querySelectorAll("input")) {
        this.querySelectorAll("input")[0].focus();
      }

    },

    _clearInputField: function (event) {
      this.set(event.currentTarget.previousElementSibling.getAttribute( 'data-bindvalue' ), '');
    },

    _togglePhoneVerification: function () {
      this.editPhoneNumber = !this.editPhoneNumber;
      this.querySelector("phone-verification-element")._clearPhoneNumber();
    },

    _getCountryFlag: function (country) {
      return (country === 'sa') ? 'sa' : '';
    },

    _inputSuggestUpdateAreas: function(_self) {
      _self.set('filteredAreas', _self.areasList.filter(function(val) {
        if (val.city_en.toLowerCase() == _self.newAddress.city.toLowerCase()) {
          return  val;
        }
      }));
      _self.set('filteredAreas', _self.filteredAreas.map(function(val) {
        if (_self.ctx.lang === 'ar') {
          if (_self.newAddress.city.toLowerCase() == val.city_en.toLowerCase()) {
            return ({ value: val.area_name_en , label: val.area_name_ar });
          }
        }
        if (_self.newAddress.city.toLowerCase() == val.city_en.toLowerCase()) {
          return ({ value: val.area_name_en , label: val.area_name_en });
        }
      }));
    },

    _addressFormValidator: function (phoneVerified, skipPhoneVerification, newAddress) {
      if (this.validatorTextField) {
        if (newAddress && newAddress.path === 'newAddress.city') {
          this.set('newAddress.area', null);
        }
        if (newAddress && this.validatorTextField.validate(this.get(newAddress.path)) && newAddress.path.split('.')[1] !== 'phone') {
          this.set('valid' + newAddress.path.split('.')[1], this.validatorTextField.validate(this.get(newAddress.path)));
        } else if (newAddress && newAddress.path.split('.')[1] === 'phone' && this.validatorPhone.validate(this.get(newAddress.path))) {
          this.set('validphone', this.validatorPhone.validate(this.get(newAddress.path)));
        }
        var addressProperties = ['name', 'city', 'area', 'building_street_no', 'phone'];
      
        if (this.isBilling) {
          var addressProperties = ['name', 'city', 'area', 'building_street_no'];
        }
      
        var addressPropertiesLength = addressProperties.length;
        for (var prop = 0; prop < addressProperties.length; prop++) {
          if (this.validatorTextField.validate(this.get('newAddress.' + addressProperties[prop]))) { addressPropertiesLength--; }
          this.canContinue = false;
          if (addressPropertiesLength < 1 && (this.phoneVerified || this.isBilling || this.skipPhoneVerification)) {
            this.canContinue = true;
          }
        }
        if (this.newAddress && this.newAddress.city) {
          this._inputSuggestUpdateAreas(this);
        }
      }
    },

    _goBack: function () {
      this.fire('go-back');
    },

    _moveToSummary: function () {
      if (this.canContinue) {
        this.fire('move-to-summary');
      }
    },

    _getCountryTranslation: function(str, country) {
      return this._translate(str + country.toUpperCase());
    },

    _alternatePhoneObserver: function() {
      if (this.validatorPhone) {
        var alternatePhone = this.validatorPhone.phoneNumberWithCountry(this.alternatePhone);
        this.newAddress.alternate_phone = alternatePhone.number;
      }
    },

    _setAddressType: function(event) {
      this.set('newAddress.addressType', event.currentTarget.value);
    },

    _translate: function (key) {
      return window.translate(key);
    }
  });

</script>
