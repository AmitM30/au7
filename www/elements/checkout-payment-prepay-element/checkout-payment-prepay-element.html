<!--
SKU details element

Example:
    <checkout-payment-prepay-element></checkout-payment-prepay-element>
@demo
-->

<dom-module id="checkout-payment-prepay-element">

  <style>
    :host {
      display: block;
      box-sizing: border-box;
    }
  </style>


  <template>
    <template is="dom-if" if="[[ _isSelectedMethod(selectedMethod) ]]" restamp="true">
      <validation-form-fields></validation-form-fields>
        
      <!-- SAVED CARD LIST START -->
      <template is="dom-if" if="[[ !addingNewCard ]]" restamp="true">
        <ul class="card-list">
          <template is="dom-if" if="[[ savedCards.length ]]" restamp="true">
            <template is="dom-repeat" items="[[ savedCards ]]" as="card" restamp="true">
              <li data-id$="[[ card.idCustomerTokenization ]]" class$="disabled-[[ card.isExpired ]]" on-click="_selectedCardChanged" data-value="[[ card.idCustomerTokenization ]]">
                <div class="custom-radio-container">
                  <label class="custom-radio-label" for="card-[[card.idCustomerTokenization]]">
                    <div class="card-details-container">
                      <div class="card-logo-container">
                        <p id="card-logo-container" class$="card-logo [[_getPaymentMethodName(card.paymentMethod) ]]"></p>
                      </div>
                      <div class="card-details">
                        <p class="card-label">[[ card.cardLabel ]]</p>
                        <p class="card-number-display">XXXX XXXX XXXX [[ card.last4 ]]</p>
                      </div>
                      <template is="dom-if" if="[[ card.isExpired ]]">
                        <div class="expired-message">
                          [[ _translate('Expired')]]
                        </div>
                      </template>
                      <div class="icon-container">
                        <span on-tap="_deleteCard" data-value="[[ card.idCustomerTokenization ]]" data-index="[[ index ]]" class="wadicon-delete">
                        </span>
                      </div>
                    </div>
                    <!-- <input type="radio" id="card-[[card.idCustomerTokenization]]" name="card" on-change="_selectedCardChanged" data-value="[[ card.idCustomerTokenization ]]"> -->
                    <!-- <input type="radio" id="card-[[card.idCustomerTokenization]]" name="card" /> -->
                    <div class="input-row-wrapper">
                      <div class="input-row">
                        <div class="input-field input-column two-third heading">
                          <div class="input-container cvv-container">
                            <input is="iron-input" placeholder="[[ _translate('CVV') ]]" prevent-invalid-input allowed-pattern="[0-9]" class$="validity-[[ validcvv ]]" name="cvv" maxlength="3" bind-value="{{ token.cvv }}" type="tel" data-bindvalue="token.cvv">
                            <p class="input-helper-message" hidden$="[[ validcvv ]]"><i class="wadicon-alert"></i>[[ _translate('Please enter the cvv number') ]]</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </label>
                </div>
              </li>
            </template>
            <li class="add-new-card">
              <div class="btn-add-card">
                <button on-tap="_addNewCard" type="button">[[ _translate('Add New Card') ]]</button>
              </div>
            </li>
          </template>
        </ul>
      </template>
      <!-- SAVED CARD LIST END -->

      <!-- ADDING NEW CARD START -->
      <template is="dom-if" if="[[ addingNewCard ]]" restamp="true">
        <template is="dom-if" if="[[ savedCards.length ]]" restamp="true">
          <div class="back-to-cards" on-click="_backToList">[[ _translate('Back') ]]</div>
        </template>
        <div class$="collapsible-area [[ _isSelectedMethod(selectedMethod) ]]" id="payment-prepay-container">
          <form id="creditCardForm" is="iron-form" novalidate>
            <div class="input-field">
              <label>[[ _translate('Enter Card Number') ]] *</label>
              <div class="input-container with-clear">
                <input is="iron-input" class$="validity-[[ validnumber ]]" prevent-invalid-input allowed-pattern="[0-9]" name="number" maxlength="16" type="tel" bind-value="{{ cardDetails.number }}" data-bindvalue="cardDetails.number">
                <template is="dom-if" if="[[ cardDetails.number.length ]]" restamp="true">
                  <a on-tap="_clearInputField" class="field-clear"><i class="wadicon-cancel"></i></a>
                </template>
                <p class="input-helper-message" hidden$="[[ validnumber ]]"><i class="wadicon-alert"></i>[[ _translate('Please enter the card number') ]]</p>
              </div>
            </div>
            <div class="input-row-wrapper">
              <label>[[ _translate('Expiry Date') ]] *</label>
              <div class="input-row">
                <div class="input-field input-column one-half">
                  <div class="input-container">
                    <div class="custom-select-container">
                      <select id="month-selector" name="expiry_month" on-change="_selectMonth">
                        <option value="null" selected>[[ _translate('Month') ]]</option>
                        <template is="dom-repeat" items="[[ months ]]" as="expiry_month" restamp="true">
                          <option value="[[ expiry_month ]]">[[ expiry_month ]]</option>
                        </template>
                      </select>
                    </div>
                    <p class="input-helper-message" hidden$="[[ validexpiry_month ]]"><i class="wadicon-alert"></i>[[ _translate('Please select the expiry month') ]]</p>
                  </div>
                </div>
                <div class="input-field input-column one-half">
                  <div class="input-container">
                    <div class="custom-select-container">
                      <select id="year-selector" name="expiry_year" on-change="_selectYear">
                        <option value="null" selected>[[ _translate('Year') ]]</option>
                        <template is="dom-repeat" items="[[ years ]]" as="expiry_year" restamp="true">
                          <option value="[[ expiry_year ]]">[[ expiry_year ]]</option>
                        </template>
                      </select>
                    </div>
                    <p class="input-helper-message" hidden$="[[ validexpiry_year ]]"><i class="wadicon-alert"></i>[[ _translate('Please select the expiry year') ]]</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="input-row-wrapper">
              <div class="input-row">
                <div class="input-field input-column one-half cvv">
                  <label>[[ _translate('CVV') ]] *</label>
                  <div class="input-container with-clear">
                    <input is="iron-input" prevent-invalid-input allowed-pattern="[0-9]" class$="validity-[[ validccv ]]" name="ccv" maxlength="3" bind-value="{{ cardDetails.ccv }}" type="tel" data-bindvalue="cardDetails.ccv">
                    <template is="dom-if" if="[[ cardDetails.ccv.length ]]" restamp="true">
                      <a on-tap="_clearInputField" class="field-clear"><i class="wadicon-cancel"></i></a>
                    </template>
                    <p class="input-helper-message" hidden$="[[ validccv ]]"><i class="wadicon-alert"></i>[[ _translate('Please enter the cvv number') ]]</p>
                  </div>
                </div>
                <div class="input-field input-column one-half card-logo-container cardlogo">
                  <span id="card-logo-container" class="card-logo"></span>
                </div>
              </div>
            </div>
            <div class="input-field">
              <label>[[ _translate('Name On Card') ]] *</label>
              <div class="input-container with-clear">
                <input is="iron-input" class$="validity-[[ validfirst_name ]]" type="text" name="first_name" bind-value="{{ cardDetails.first_name }}" data-bindvalue="cardDetails.first_name">
                <template is="dom-if" if="[[ cardDetails.first_name.length ]]" restamp="true">
                  <a on-tap="_clearInputField" class="field-clear"><i class="wadicon-cancel"></i></a>
                </template>
                <p class="input-helper-message" hidden$="[[ validfirst_name ]]"><i class="wadicon-alert"></i>[[ _translate("Please enter the cardholderâ€™s name") ]]</p>
              </div>
            </div>
            <div class="custom-checkbox-container billing-address-trigger">
              <label class="custom-checkbox-label" for="billing-address">
                <input type="checkbox" id="billing-address" collapse="#billing-required" on-change="_toggleBillingAddress" checked>
                <span class="label-text">[[ _translate('Billing is same as shipping address') ]]</span>
                <div class="check-indicator"></div>
              </label>
            </div>
            <div class="custom-checkbox-container billing-address-trigger">
              <label class="custom-checkbox-label" for="save-card">
                <input type="checkbox" id="save-card" checked$="{{ cardDetails.save_card }}" on-change="_saveCardToggle">
                <span class="label-text">[[ _translate('Save this card for future use') ]]</span>
                <div class="check-indicator"></div>
              </label>
            </div>
            <iron-collapse id="billing-required">
              <new-address-element
                new-address="{{ billingAddress }}"
                ctx$="[[ ctx ]]"
                options='{"title": "Billing Address", "opensIndependently": true, "type": "billing"}'
                cities-list="[[ citiesList ]]"
                areas-list="[[ areasList ]]"
                phone-config="[[ phoneConfig ]]"
                can-continue="{{ billingAddressValid }}"
              ></new-address-element>
            </iron-collapse>
          </form>
        </div>
      </template>
      <!-- ADDING NEW CARD END -->
    </template>
  </template>

</dom-module>

<script>

  Polymer({
    is: 'checkout-payment-prepay-element',

    properties: {

      /**
       * Application context
       */
      ctx: {
        type: Object
      },

      cardDetails: {
        type:Object,
        value: function () {
          return {};
        }
      },

      billingAddress: {
        type: Object,
        value: function () {
          return {};
        },
        notify:true
      },

      canPlaceOrder: {
        type: Boolean,
        value: function () {
          return {};
        },
        notify: true
      },

      billingAddressValid: {
        type: Boolean,
        value: function () {
          return {};
        },
        notify: true
      },

      /**
       * Phone configuration
       */
      phoneConfig: {
        type:Object
      },

      /**
     *  year range for credit card
     **/

      yearRange: {
        type: Object
      },

      selectedMethod: {
        type: String
      },

      /**
       * Saved cards array
       **/
      savedCards: {
        type: Object,
        value: [],
        observer: '_savedCardsObserver',
        notify: true
      },

      addingNewCard: {
        type: Boolean,
        value: false,
        observer: '_addingNewCardObserver'
      },

      token: {
        type: Object,
        value: {}
      }
    },

    observers: ['_canPlaceOrderValidator(billingAddressValid, cardDetails.*, billingRequired, token.*)'],

    // Element Lifecycle
    attached: function () {
      var _self = this;
      var cardProperties = ['first_name', 'number', 'expiry_month', 'expiry_year', 'ccv'];

      this.years = [];
      this.months = [];
      this._getYearMonthRange();
      this.validatorTextField = new Polymer.IronMeta({type: 'validator'}).byKey('validation-form-fields');
      this.billingRequired = false;
      this.validcvv = true;

      for (var prop = 0; prop < cardProperties.length; prop++) {
        this.set('valid' + cardProperties[prop], true);
      }

      this.addEventListener('focusout', function (event) {
        if (event.target && event.target.getAttribute('name') && this.validatorTextField && (cardProperties.indexOf(event.target.getAttribute('name')) !== -1)) {
          this.set('valid' + event.target.getAttribute('name'), this.validatorTextField.validate(this.get('cardDetails.' + event.target.getAttribute('name'))));
        }
        if (event.target && event.target.getAttribute('name') === 'number') {

          _self.debounce('focusout', function() {
            _self.fire('post-order-review');
          }, 250);
        }
        if (event.target && event.target.getAttribute('name') && this.validatorTextField && event.target.getAttribute('name') === 'cvv') {
          this.set('valid' + event.target.getAttribute('name'), this.validatorTextField.validate(this.get('token.' + event.target.getAttribute('name'))));
        }
      }, { passive: true });

      this.addEventListener("dom-change", function (e) {
        _self._checkDefaultCard();

        // TODO - why do we need this
        // if (this.querySelectorAll("input") && this.querySelectorAll("input")[0]) {
        //   this.querySelectorAll("input")[0].focus();
        // }
      });

      _self._checkDefaultCard();

      if (this.querySelectorAll("input") && this.querySelectorAll("input")[0]) {
        this.querySelectorAll("input")[0].focus();
      }

      this._isSelectedMethod(this.selectedMethod);
    },

    _clearInputField: function (event) {
      this.set(event.currentTarget.previousElementSibling.getAttribute( 'data-bindvalue' ), '');
    },

    _luhnChk: function (luhn) {

      var len = luhn.length,
          mul = 0,
          prodArr = [
              [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
              [0, 2, 4, 6, 8, 1, 3, 5, 7, 9]
          ],
          sum = 0;

      while (len--) {
          sum += prodArr[mul][parseInt(luhn.charAt(len), 10)];
          mul ^= 1;
      }

      return sum % 10 === 0 && sum > 0;
    },

    /**
     * Verifies the card number is valid or not using
     * @param number {string} - creditcard number
     * @returns {boolean}
     */
    _verifyCard: function (number) {
        return number ? luhnChk(number): false;
    },

  /**
   * returns the credit card issuer name
   * for now, only master card and visa card supported
   * @param number {string} - creditcard number
   * @returns {string|undefined}
   */
    _getCardType: function (number) {
      var classList = this.querySelector('#card-logo-container').classList.remove('mastercard', 'visa');
        return (/^5[1-5]/.test(number)) ? this.querySelector('.card-logo').classList.add('mastercard')
            : (/^4/.test(number)) ? this.querySelector('.card-logo').classList.add('visa')
            : null;
    },

    _canPlaceOrderValidator: function(billingAddressValid, cardDetails, billingRequired){
      if (this.selectedMethod === 'cc' && this.addingNewCard) {
        if (cardDetails && cardDetails.path === 'cardDetails.number') {
          this._getCardType(cardDetails.value);
        }
        if (this.validatorTextField) {
          if (cardDetails && cardDetails.path && this.validatorTextField.validate(this.get(cardDetails.path))) {
            this.set('valid' + cardDetails.path.split('.')[1], this.validatorTextField.validate(this.get(cardDetails.path)));
          }
          var cardProperties = ['first_name', 'number', 'expiry_month', 'expiry_year', 'ccv'];
          var cardPropertiesLength = cardProperties.length;
          for (var prop = 0; prop < cardProperties.length; prop++) {
            this.validatorTextField.validate(this.get('cardDetails.' + cardProperties[prop])) && cardPropertiesLength--;
            this.set('canPlaceOrder', false);
            if (cardPropertiesLength < 1 && (this.billingAddressValid || !this.billingRequired)) {
              this.set('canPlaceOrder', true);
            }
          }
        }
      } else if (!this.addingNewCard && this.selectedMethod === 'cc' && this.validatorTextField) {
        if (this.token.cvv && this.validatorTextField.validate(this.token.cvv)) {
          this.set('canPlaceOrder', true);
          this.set("validcvv", true);
        } else {
          this.set('canPlaceOrder', false);
        }
      }
    },

    _getYearMonthRange: function () {
      var dateYear = new Date().getFullYear();
      for (var i = 0; i < this.yearRange; i++) {
        this.push('years', dateYear+i);
      }
      for (var i = 1; i <= 12; i++) {
        this.push('months', (i.toString().length > 1) ? i.toString() : "0" + i.toString());
      }
    },

    _selectYear: function (event) {
      this.set("cardDetails.expiry_year", parseInt(event.target.value));
    },

    _selectMonth: function (event) {
      this.set("cardDetails.expiry_month", parseInt(event.target.value));
    },

    _toggleBillingAddress: function (event) {
      this.set('billingRequired', !this.billingRequired);
      this.querySelector(event.currentTarget.getAttribute('collapse')).toggle();
    },

    _isSelectedMethod: function(selectedMethod) {
      if (selectedMethod !== 'cc') {
        this.token.id = null;
        this.token.cvv = null;
        // this.addingNewCard = false;
        this.set('addingNewCard', false);
        this.validcvv = true;
        this._resetDropdown();
      }

      return (selectedMethod === 'cc') ? true : false;
    },
    
    _savedCardsObserver: function (newVal, oldVal) {
      if (this.savedCards && this.savedCards.length > 0) {
        this.set("addingNewCard", false);
      } else {
        this.set("addingNewCard", true);
      }
    },

    _getPaymentMethodName: function (methodName) {
      return methodName.toLowerCase();
    },

    _addNewCard: function () {
      this.set("addingNewCard", true);
    },

    _addingNewCardObserver: function (newVal, oldVal) {
      if (this.addingNewCard) {
        if(this.token) {
           this.set('token.id', null);
        }
      } else {
        if(this.cardDetails) {
          this.set('cardDetails.number', null);
        }
      }
    },

    _selectedCardChanged: function (event) {
      event.preventDefault();

      if (event.currentTarget.dataValue) {
        if (this.querySelectorAll('.card-list > li.disabled-false') 
          && this.querySelectorAll('.card-list > li.disabled-false').length > 0 
          && this.querySelector('.card-list > li.disabled-false[data-id="' + event.currentTarget.dataValue + '"]')) {
          var list = this.querySelectorAll('.card-list > li.disabled-false');

          for(var i = 0; i < list.length; i++) {
            this.querySelectorAll('.card-list > li.disabled-false')[i].classList.remove('active');
          }

          this.querySelector('.card-list > li.disabled-false[data-id="' + event.currentTarget.dataValue + '"]').classList.add('active');

          if (event.currentTarget.dataValue !== this.token.id) {
            this.set("token.cvv", '');
            this.set("validcvv", true);
          }
          
          this.token.id = event.currentTarget.dataValue;
        }

      }
    },

    _deleteCard: function (event) {
      this.splice('savedCards', event.target.dataIndex, 1);
      if (this.savedCards.length < 1) {
        this.set('addingNewCard', true);
      }
      this.fire('delete-saved-card', { id: event.target.dataValue });
    },

    _saveCardToggle: function () {
      this.cardDetails.save_card = !this.cardDetails.save_card;
    },

    _checkDefaultCard: function () {
      if (this.querySelector('.card-list > li.disabled-false')) {
          var list = this.querySelectorAll('.card-list > li.disabled-false');
          var inputChecked = false;
          for (var i = 0; i < list.length; i++) {
            if (list[i].checked) {
              inputChecked = true;
              break;
            }
          }
  
          if (!inputChecked) {
            this.querySelector('.card-list > li.disabled-false').classList.add('active');
            this.querySelector('.card-list > li.disabled-false input').checked = true;
            this.token.id = list[0].getAttribute('data-id');
          }
        }
    },

    _backToList: function () {
      // this.addingNewCard = false;
      this.set('addingNewCard', false);
    },

    _resetDropdown: function() {
      var yearSelector = this.querySelector("#year-selector");
      var monthSelector = this.querySelector("#month-selector");

      if (yearSelector) {
        yearSelector.selectedIndex = 0;
      }

      if (monthSelector) {
        monthSelector.selectedIndex = 0;
      }
    },

    _translate: function (key) {
      return window.translate(key);
    }
  });

</script>
