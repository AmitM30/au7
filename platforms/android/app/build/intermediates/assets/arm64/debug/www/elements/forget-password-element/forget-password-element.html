<!--
Widget to add forget password functionality

Example:
        <forget-password-element  options='{ "title": "Forget Password?" }' ></forget-password-element>
@demo
-->
<dom-module id="forget-password-element">

  <style>
    :host {
      display: block;
      box-sizing: border-box;
    }
  </style>

  <template>
    <a class="option" collapse="#forgetpassword" on-click="_toggle">[[ _translate('Forgot Password?') ]]</a>
    <iron-collapse id="forgetpassword">
      <validation-email></validation-email>
      <validation-password></validation-password>

      <!-- PASSWORD RESET REQUEST FORM START -->
      <template is="dom-if" if="[[ !passResetRequestSent ]]">
        <form id="forgotPassRequestForm" is="iron-form" method="GET" novalidate on-submit="_passwordResetRequest">
          <div class="input-container with-clear">
            <input class$="validity-[[validEmai]]" type="email" on-input="_clearValidation" is="iron-input" bind-value="{{ email }}" placeholder="[[ _translate('Email') ]]">
            <template is="dom-if" if="[[ email.length ]]">
              <a on-tap="_clearField" class="field-clear"><i class="wadicon-cancel"></i></a>
            </template>
            <p class="input-helper-message" hidden$="[[validEmail]]"><i class="wadicon-alert"></i>[[_translate('Please enter a valid email address')]]</p>
          </div>
          <button class="core-block-cta core-block-cta-tertiary cta-full-width" type="submit" disabled$="[[ !email.length ]]">[[ _translate('Reset Password') ]]<paper-ripple></paper-ripple></button>
        </form>
      </template>
      <!-- PASSWORD RESET REQUEST FORM END -->

      <!-- PASSWORD RESET FORM START -->
      <template is="dom-if" if="[[ passResetRequestSent ]]">
        <form id="forgotPassResetForm" is="iron-form" method="GET" novalidate on-submit="_passwordReset">
          <div class="input-field">
            <div class="highlight-memo">
              <p>[[ _translate('_resetCodeEmailMessage') ]] <strong>[[email]]</strong></p>
            </div>
            <div class="input-container">
              <input class$="validity-{{validPassword}}" is="iron-input" on-input="_clearValidation" bind-value="{{ loginPassword }}" type="password" placeholder="[[ _translate('New Password') ]]" />
              <template is="dom-if" if="[[ loginPassword.length ]]">
                <a on-tap="_clearPasswordField" class="field-clear"><i class="wadicon-cancel"></i></a>
              </template>
              <p class="input-helper-message" hidden$="[[validPassword]]"><i class="wadicon-alert"></i>[[_translate('Please enter your password')]]</p>
            </div>
          </div>
          <div class="input-field">
            <div class="input-container">
              <input is="iron-input" class$="validity-[[passwordMatch]]" on-input="_clearValidation" bind-value="{{ tempPassword }}" type="password" placeholder="[[ _translate('Confirm Password') ]]" />
              <template is="dom-if" if="[[ tempPassword.length ]]">
                <a on-tap="_clearTempPasswordField" class="field-clear"><i class="wadicon-cancel"></i></a>
              </template>
              <p class="input-helper-message" hidden$="[[passwordMatch]]"><i class="wadicon-alert"></i>[[_translate('Password and confirm password should match')]]</p>
            </div>
          </div>
          <div class="input-field">
            <div class="input-container">
              <input is="iron-input" bind-value="{{ restorePasswordKey }}" prevent-invalid-input allowed-pattern="\d" type="tel" placeholder="[[ _translate('restorePasswordKey') ]]" />
              <template is="dom-if" if="[[ restorePasswordKey.length ]]">
                <a on-tap="_clearRestoreKeyField" class="field-clear"><i class="wadicon-cancel"></i></a>
              </template>
            </div>
          </div>
          <button class="core-block-cta cta-full-width" disabled$="[[ !loginPassword.length ]]" type="submit">[[ _translate('Continue') ]]<paper-ripple></paper-ripple></button>
        </form>
      </template>
      <!-- PASSWORD RESET FORM END -->

    </iron-collapse>
  </template>

</dom-module>

<script>

Polymer({

    is: 'forget-password-element',

    properties: {
      options: {
        type: Object
      },

      email: {
        type: String
      },

      passResetRequestSent: {
        type:Boolean,
        value: false
      },

      tempPassword: {
        type: String,
        value: null
      },

      passwordMatch: {
        type: Boolean,
        value: true
      }
    },

    attached: function () {
      this.validatorEmail = new Polymer.IronMeta({type: 'validator'}).byKey('validation-email');
      this.validatorPassword = new Polymer.IronMeta({type: 'validator'}).byKey('validation-password');
      this.validEmail = true;
      this.validPassword = true;
      this.passResetRequestSent = false;
      this.tempPassword = null;
      this.passwordMatch = true;

      this.addEventListener('iron-form-presubmit', function(event) {
        event.preventDefault();
      });
    },

    _passwordResetRequest: function(event) {
      this.validEmail = this.validatorEmail.validate(this.email);
      if (!this.validEmail) {
        event.preventDefault();
      }
      else {
        this.fire('password-reset-request', { email: this.email });
      }
    },

    _passwordReset: function(event) {
      this.validEmail = this.validatorEmail.validate(this.email);
      this.validPassword = this.validatorPassword.validate(this.loginPassword);
      this.passwordMatch = (this.loginPassword === this.tempPassword);

      if (!this.validEmail || !this.validPassword || !this.passwordMatch) {
        event.preventDefault();
      }
      else {
        this.fire('password-reset', { "email": this.email, "password": this.loginPassword, "restorePasswordKey": this.restorePasswordKey });
      }
    },

    _clearPasswordField: function() {
      this.loginPassword = '';
      this.passwordMatch = true;
      this.validPassword = true;
    },

    _clearRestoreKeyField: function() {
      this.restorePasswordKey = '';
      this.passwordMatch = true;
    },

    _clearValidation: function() {
      this.passwordMatch = true;
      this.validPassword = true;
      this.validEmail = true;
    },

    _clearTempPasswordField: function() {
      this.tempPassword = '';
      this.validPassword = true;
      this.passwordMatch = true;
    },

    _toggle: function (event) {
      var node = event.currentTarget.getAttribute('collapse');
      this.querySelector(node).toggle();
      event.currentTarget.classList.toggle('opened');
    },

    _clearField: function() {
      this.set('email', '');
    },

    _translate: function (key) {
      return window.translate(key);
    }
  });

  </script>
